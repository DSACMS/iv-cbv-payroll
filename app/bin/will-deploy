#!/usr/bin/env bash
# Use this script when preparing for a deploy:
#
#   bin/will-deploy
#
# The output will be automatically copied to your clipboard.
# Then paste the message into Slack and apply formatting with Cmd+Shift+F.
set -euo pipefail

linkify_jira() {
  # Convert "FFS-1234:" (or just "1234:") into a Jira link
  sed -E 's/(FFS-)?([0-9]{3,4})(-[0-9]*)?:? (.*)/\4 \[[FFS-\2](https:\/\/jiraent.cms.gov\/browse\/FFS-\2)\]/g' |
    # Convert "(#123)" into a Github PR link
    sed -E 's|\(#([0-9]*)\)|([#\1](https://github.com/DSACMS/iv-cbv-payroll/pull/\1))|' /dev/stdin
}

# Run with --test to test the regular expressions above
if [ ${1:-""} = "--test" ]; then
  echo "1234: Foo bar baz" | linkify_jira
  echo "FFS-1234: Foo bar baz" | linkify_jira
  echo "FFS-1234 Foo bar baz" | linkify_jira
  echo "FFS-1234-3: Foo bar baz" | linkify_jira
  echo "FFS-1234-3: Foo bar baz (#123)" | linkify_jira
  exit
fi

git fetch --quiet
prod=$(curl --silent https://snap-income-pilot.com/health | jq -r .version)
current_sha=$(git rev-parse origin/main)

# Arrays to store categorized changes (initialize as empty)
both_changes=()
cbv_changes=()
hr1_changes=()
other_changes=()

echo "Categorizing changes for deployment..." >&2
echo "======================================" >&2
echo "" >&2

# Read commits with commit hashes into an array
mapfile -t commits < <(git log --no-decorate --pretty="format:%s - %an|%H" ${prod}..${current_sha})

# Process each commit
for commit_line in "${commits[@]}"; do
  # Split commit message and hash
  commit="${commit_line%|*}"
  commit_hash="${commit_line#*|}"

  # Extract PR number if present
  pr_link=""
  if [[ $commit =~ \(#([0-9]+)\) ]]; then
    pr_num="${BASH_REMATCH[1]}"
    pr_link="https://github.com/DSACMS/iv-cbv-payroll/pull/${pr_num}"
    echo "Change: $commit" >&2
    echo "PR: $pr_link" >&2
  else
    # No PR, show commit link instead
    commit_link="https://github.com/DSACMS/iv-cbv-payroll/commit/${commit_hash}"
    echo "Change: $commit" >&2
    echo "Commit: $commit_link" >&2
  fi

  # Loop until valid category is provided
  while true; do
    echo "Is this user-facing? (b=Both CBV+HR1, c=CBV, h=HR1, o=Other/Maintenance, s=Skip): " >&2
    read -r category

    case "$category" in
      b|B)
        both_changes+=("$commit")
        break
        ;;
      c|C)
        cbv_changes+=("$commit")
        break
        ;;
      h|H)
        hr1_changes+=("$commit")
        break
        ;;
      o|O)
        other_changes+=("$commit")
        break
        ;;
      s|S)
        echo "Skipping..." >&2
        break
        ;;
      *)
        echo "Invalid option. Please enter b, c, h, o, or s." >&2
        ;;
    esac
  done
  echo "" >&2
done

# Generate output and capture it
output='ðŸš€ Will deploy `'${current_sha:0:7}'` to production: ðŸš€ (cc @emmy-platform)'$'\n\n'

# Add categorized changes to output
if [ ${#both_changes[@]} -gt 0 ]; then
  output+="ðŸ‘¥ *User facing changes to CBV + HR1*"$'\n'
  for change in "${both_changes[@]}"; do
    output+="$(echo "  â€¢ $change" | linkify_jira)"$'\n'
  done
fi

if [ ${#cbv_changes[@]} -gt 0 ]; then
  output+="ðŸ“ *CBV only user facing changes*"$'\n'
  for change in "${cbv_changes[@]}"; do
    output+="$(echo "  â€¢ $change" | linkify_jira)"$'\n'
  done
fi

if [ ${#hr1_changes[@]} -gt 0 ]; then
  output+="ðŸ† *HR1 only user facing changes*"$'\n'
  for change in "${hr1_changes[@]}"; do
    output+="$(echo "  â€¢ $change" | linkify_jira)"$'\n'
  done
fi

if [ ${#other_changes[@]} -gt 0 ]; then
  output+="âš™ï¸ *Other/Maintenance (Not user facing)*"$'\n'
  for change in "${other_changes[@]}"; do
    output+="$(echo "  â€¢ $change" | linkify_jira)"$'\n'
  done
fi

output+=$'\n'"ðŸ‘€ Check out the changes at [https://la-verify-demo.navapbc.cloud/](https://la-verify-demo.navapbc.cloud/)"$'\n'
output+=$'\n'"See the [full diff on Github](https://github.com/DSACMS/iv-cbv-payroll/compare/${prod:0:7}..${current_sha:0:7})."$'\n'

# Display output to user
echo "$output"

# Copy to clipboard
echo "$output" | pbcopy
echo "" >&2
echo "âœ… Deployment message copied to clipboard!" >&2
