name: Comment Terraform plans

on:
  pull_request:
    paths:
      - 'infra/**'

jobs:
  plan_comment:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    strategy:
      matrix:
        app-name: [app]
        environment: [dev]
        include:
          - terraform-cmd: |
              terraform -chdir="infra/${{ matrix.app-name }}/service" init -input=false -reconfigure -backend-config="${{ matrix.environment }}.s3.tfbackend"
              terraform -chdir="infra/${{ matrix.app-name }}/service" plan -lock=false -var="environment_name=${{ matrix.environment }}" -out .planfile
            working-directory: infra/${{ matrix.app-name }}/service
            header: "üìù Terraform Plan: Service"
          - terraform-cmd: |
              terraform -chdir="infra/networks" init -input=false -reconfigure -backend-config="${{ matrix.environment }}.s3.tfbackend"
              terraform -chdir="infra/networks" plan -lock=false -var="network_name=${{ matrix.environment }}" -out .planfile
            working-directory: infra/networks
            header: "üìù Terraform Plan: Network"
          - terraform-cmd: |
              terraform -chdir="infra/${{ matrix.app-name }}/database" init -input=false -reconfigure -backend-config="${{ matrix.environment }}.s3.tfbackend"
              terraform -chdir="infra/${{ matrix.app-name }}/database" plan -lock=false -var="environment_name=${{ matrix.environment }}" -out .planfile
            working-directory: infra/${{ matrix.app-name }}/database
            header: "üìù Terraform Plan: Database"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Terraform
      uses: ./.github/actions/setup-terraform

    - name: Configure AWS credentials
      uses: ./.github/actions/configure-aws-credentials
      with:
        app_name: ${{ matrix.app-name }}
        environment: ${{ matrix.environment }}

    - name: Run Terraform plan
      run: ${{ matrix.terraform-cmd }}

    - name: Comment Terraform plan if changed
      uses: borchero/terraform-plan-comment@v2
      with:
        token: ${{ github.token }}
        working-directory: ${{ matrix.working-directory }}
        planfile: .planfile
        header: ${{ matrix.header }}
        skip-empty: true
