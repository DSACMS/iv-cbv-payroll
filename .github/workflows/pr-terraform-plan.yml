name: Comment Terraform plans

on:
  pull_request:
    paths:
      - 'infra/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  plan_comment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      APP_NAME: app
      ENVIRONMENT: dev
    strategy:
      matrix:
        include:
          - terraform-cmd: terraform -chdir="infra/app/service" init -input=false -reconfigure -backend-config="dev.s3.tfbackend" && terraform -chdir="infra/app/service" plan -var="environment_name=dev" -out .planfile
            working-directory: infra/app/service
            header: "ğŸ“ Terraform Plan: Service"
          # - terraform-cmd: |
          #     terraform -chdir="infra/app/service" init -input=false -reconfigure -backend-config="dev.s3.tfbackend"
          #     terraform -chdir="infra/app/service" plan -var="environment_name=dev"
          #   planfile: service.plan
          #   header: "ğŸ“ Terraform Plan: Service"
          # - terraform-cmd: |
          #     terraform -chdir="infra/networks" init -input=false -reconfigure -backend-config="dev.s3.tfbackend"
          #     terraform -chdir="infra/networks" plan -var="network_name=dev"
          #   planfile: network.plan
          #   header: "ğŸ“ Terraform Plan: Network"
          # - terraform-cmd: |
          #     terraform -chdir="infra/app/database" init -input=false -reconfigure -backend-config="dev.s3.tfbackend"
          #     terraform -chdir="infra/app/database" plan -var="environment_name=dev"
          #   planfile: network.plan
          #   header: "ğŸ“ Terraform Plan: Database"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Terraform
      uses: ./.github/actions/setup-terraform

    - name: Configure AWS credentials
      uses: ./.github/actions/configure-aws-credentials
      with:
        app_name: app
        environment: dev

    - name: Run Terraform plan
      run: ${{ matrix.terraform-cmd }}

    - name: Comment Terraform plan if changed
      uses: borchero/terraform-plan-comment@v2
      with:
        token: ${{ github.token }}
        working-directory: ${{ matrix.working-directory }}
        planfile: .planfile
        header: ${{ matrix.header }}
        skip-empty: true
